<!DOCTYPE html>

<html>
<head>
  <title>server.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="childPro.html">
                childPro.js
              </a>
            
              
              <a class="source" href="del.html">
                del.js
              </a>
            
              
              <a class="source" href="deleteAll.html">
                deleteAll.js
              </a>
            
              
              <a class="source" href="errcode.html">
                errcode.js
              </a>
            
              
              <a class="source" href="get.html">
                get.js
              </a>
            
              
              <a class="source" href="index.html">
                index.js
              </a>
            
              
              <a class="source" href="insert.html">
                insert.js
              </a>
            
              
              <a class="source" href="load-oauth-secrets.html">
                load-oauth-secrets.js
              </a>
            
              
              <a class="source" href="oauth.html">
                oauth.js
              </a>
            
              
              <a class="source" href="populate-oauth-secrets.html">
                populate-oauth-secrets.js
              </a>
            
              
              <a class="source" href="queryValidation.html">
                queryValidation.js
              </a>
            
              
              <a class="source" href="requestHandlers.html">
                requestHandlers.js
              </a>
            
              
              <a class="source" href="responseHandlers.html">
                responseHandlers.js
              </a>
            
              
              <a class="source" href="router.html">
                router.js
              </a>
            
              
              <a class="source" href="schemaValidation.html">
                schemaValidation.js
              </a>
            
              
              <a class="source" href="server.html">
                server.js
              </a>
            
              
              <a class="source" href="update.html">
                update.js
              </a>
            
              
              <a class="source" href="updateValidation.html">
                updateValidation.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>server.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> http = require(<span class="string">"http"</span>);
<span class="keyword">var</span> responseHandlers = require(<span class="string">'./responseHandlers'</span>);
<span class="keyword">var</span> jsonsp = require(<span class="string">'jsonsp'</span>);
<span class="keyword">var</span> util = require(<span class="string">'util'</span>);
<span class="keyword">var</span> oauth = require(<span class="string">'./oauth'</span>);

<span class="function"><span class="keyword">function</span> <span class="title">start</span><span class="params">(route, handle)</span> {</span>
	<span class="function"><span class="keyword">function</span> <span class="title">onRequest</span><span class="params">(request, response)</span> {</span>
		<span class="keyword">var</span> urlString = request.url;
		<span class="keyword">var</span> postData = <span class="string">""</span>;
		<span class="keyword">var</span> postDataRaw = <span class="string">""</span>;
		<span class="keyword">var</span> method = request.method;
		
		<span class="keyword">var</span> parser = <span class="keyword">new</span> jsonsp.Parser();
		<span class="keyword">if</span> (method == <span class="string">"GET"</span> || method == <span class="string">"DELETE"</span>){
			<span class="keyword">var</span> sig_valid = <span class="literal">false</span>;
			<span class="keyword">if</span>(nodeConfig.oauth_enabled == <span class="literal">true</span>){
				sig_valid = oauth.verifyOAuthSignature(method.toUpperCase(), request.headers, <span class="string">"http"</span>, urlString, <span class="string">""</span>);
			} <span class="keyword">else</span> {
				sig_valid = <span class="literal">true</span>;
			}
			<span class="keyword">if</span>(sig_valid == <span class="literal">true</span>){
				route(handle, method, urlString, response, postData);		
			} <span class="keyword">else</span> {
				responseHandlers.invalidRequest(response,<span class="number">1</span>);
			}
		}
		<span class="keyword">else</span> {
			parser.on(<span class="string">'object'</span>, <span class="keyword">function</span>(input) {
				postData = input;
				request.addListener(<span class="string">"end"</span>, <span class="keyword">function</span>(){
						<span class="keyword">var</span> sig_valid = <span class="literal">false</span>;
						<span class="keyword">if</span>(nodeConfig.oauth_enabled == <span class="literal">true</span>){
							sig_valid = oauth.verifyOAuthSignature(request.method.toUpperCase(), request.headers, <span class="string">"http"</span>, urlString, postDataRaw);
						} <span class="keyword">else</span> {
							sig_valid = <span class="literal">true</span>;
						}
						<span class="keyword">if</span>(sig_valid == <span class="literal">true</span>){
							route(handle, method, urlString, response, postData);		
						} <span class="keyword">else</span> {
							responseHandlers.invalidRequest(response,<span class="number">1</span>);
						}		
				});
			});
			parser.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(input)</span> {</span>
				console.log(<span class="string">"parse error"</span>);
				responseHandlers.invalidRequest(response,<span class="number">2</span>);	
			});
		}		
		
		console.log(<span class="string">"Request for "</span> + urlString + <span class="string">" received."</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>see comments below for more details.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="keyword">var</span> chunkEnd = <span class="string">""</span>;
		request.addListener(<span class="string">"data"</span>, <span class="keyword">function</span>(postDataChunk) {
			postDataChunk = postDataChunk.toString(<span class="string">'utf8'</span>);
			postDataRaw += postDataChunk;
			<span class="keyword">if</span>(postDataChunk[<span class="number">0</span>] == <span class="string">'p'</span> &amp;&amp; postDataChunk[<span class="number">1</span>] == <span class="string">'='</span>){</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>get rid of p= at the front.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				postDataChunk = postDataChunk.substring(<span class="number">2</span>);
			}
			<span class="comment">/*
			* Since the data is URL encoded, a chunk could end with part of a URL encoded character.
			* For example, a chunk "%7B%22type%22%3A%" could come in, and then a chunk "22collect%22" after it.
			* This would be a problem for decodeURIComponent due to the %22 being split between the two chunks.
			* The partial urlencoded character will be stored in the chunkEnd variable and prepended to the next chunk.
			*/</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>prepend partial URLencoded character (if any) from last chunk to the current chunk</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			postDataChunk = chunkEnd + postDataChunk;
			<span class="keyword">if</span>(postDataChunk[postDataChunk.length - <span class="number">1</span>] == <span class="string">'%'</span>){</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>ends with %</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				chunkEnd = <span class="string">'%'</span>;
				postDataChunk = postDataChunk.substring(<span class="number">0</span>, postDataChunk.length -<span class="number">1</span>);
			} <span class="keyword">else</span> <span class="keyword">if</span>(postDataChunk[postDataChunk.length - <span class="number">2</span>] == <span class="string">'%'</span>){</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>second to last character is %</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				chunkEnd = postDataChunk.substring(postDataChunk.length-<span class="number">2</span>, postDataChunk.length);
				postDataChunk = postDataChunk.substring(<span class="number">0</span>, postDataChunk.length -<span class="number">2</span>);
			} <span class="keyword">else</span> {
				chunkEnd = <span class="string">""</span>;
			}

			parser.parse(decodeURIComponent(postDataChunk));
		});			
	}
	http.createServer(onRequest).listen(nodeConfig.port);
	console.log(<span class="string">"Server has started."</span>);
}

exports.start = start;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
